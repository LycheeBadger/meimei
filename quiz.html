<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Vocabulary Practice - Quiz</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f4f4f4;
      }
      #quiz-container {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        width: 90%;
        text-align: center;
        margin: 24px;
      }
      h1 {
        font-size: 28px;
        margin-bottom: 24px;
      }
      #question {
        font-size: 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }
      #question-zh {
        font-size: 16px;
        color: #555;
        font-style: italic;
        margin-bottom: 24px;
        text-align: center;
      }
      .option-zh {
        font-size: 16px;
        color: #555;
        font-style: italic;
        margin-bottom: 12px;
        text-align: left;
        margin-left: 16px;
      }
      .option,
      .select-all-option,
      .true-false-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        margin: 12px auto;
        width: 94%;
        background: #e0e0e0;
        border: 1px solid #ccc;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        text-align: left;
        transition: background 0.2s;
        word-wrap: break-word;
      }
      .option:hover,
      .select-all-option:hover,
      .true-false-option:hover {
        background: #d0d0d0;
      }
      .select-all-option label {
        flex-grow: 1;
      }
      .select-all-option input[type="checkbox"] {
        width: 24px;
        height: 24px;
        margin-right: 12px;
      }
      .fill-in-the-blank {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 12px auto;
        width: 94%;
      }
      .fill-in-the-blank input[type="text"] {
        padding: 12px;
        width: 100%;
        max-width: 300px;
        font-size: 18px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .fill-in-the-blank input[type="text"].correct {
        background: #c8e6c9;
        border-color: #2e7d32;
      }
      .fill-in-the-blank input[type="text"].incorrect {
        background: #ffcdd2;
        border-color: #c62828;
      }
      .correct {
        background: #c8e6c9 !important;
      }
      .incorrect {
        background: #ffcdd2 !important;
      }
      .audio-icon {
        cursor: pointer;
        width: 28px;
        height: 28px;
        color: #28a745;
        flex-shrink: 0;
      }
      .audio-icon:hover,
      .audio-icon:active {
        color: #218838;
      }
      #feedback {
        margin-top: 24px;
        font-size: 18px;
        color: #333;
      }
      #feedback.green {
        background: #c8e6c9;
        color: #2e7d32;
      }
      #feedback.red {
        background: #ffcdd2;
        color: #c62828;
      }
      .tense-info {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        margin-bottom: 12px;
        text-align: center;
      }
      #next-btn,
      #exit-btn,
      #submit-btn,
      #retry-btn {
        margin: 12px;
        padding: 12px 24px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
        min-width: 120px;
        min-height: 48px;
      }
      #next-btn:hover,
      #exit-btn:hover,
      #submit-btn:hover,
      #retry-btn:hover {
        background: #218838;
      }
      .button-container {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 12px;
        flex-wrap: wrap;
      }
      #progress-container {
        width: 85%;
        margin: 24px auto;
        font-size: 16px;
      }
      #progress-bar {
        height: 24px;
        background: #28a745;
        width: 0%;
        border-radius: 12px;
        margin-bottom: 8px;
      }
      #missed-progress-bar {
        height: 24px;
        background: #ff6f61;
        width: 0%;
        border-radius: 12px;
        margin-bottom: 8px;
      }
      #stats {
        text-align: center;
        margin-top: 8px;
      }
      @media (max-width: 600px) {
        #quiz-container {
          padding: 16px;
          width: 92%;
          margin: 16px;
        }
        h1 {
          font-size: 24px;
        }
        #question {
          font-size: 18px;
          gap: 10px;
        }
        #question-zh,
        .option-zh,
        #stats {
          font-size: 14px;
          margin-left: 12px;
        }
        #question-zh {
          margin-left: 0;
        }
        .option,
        .select-all-option,
        .true-false-option {
          padding: 12px;
          font-size: 16px;
          width: 92%;
          margin: 8px auto;
        }
        .fill-in-the-blank input[type="text"] {
          font-size: 16px;
          padding: 10px;
          max-width: 250px;
        }
        .select-all-option input[type="checkbox"] {
          width: 20px;
          height: 20px;
          margin-right: 10px;
        }
        .audio-icon {
          width: 24px;
          height: 24px;
        }
        #feedback {
          font-size: 16px;
          margin-top: 16px;
        }
        #next-btn,
        #exit-btn,
        #submit-btn,
        #retry-btn {
          font-size: 16px;
          padding: 10px 20px;
          margin: 8px;
          min-width: 100px;
          min-height: 44px;
        }
        #progress-container {
          width: 90%;
          font-size: 14px;
        }
        #progress-bar,
        #missed-progress-bar {
          height: 20px;
          margin-bottom: 6px;
        }
        #stats {
          margin-top: 6px;
        }
        .button-container {
          flex-direction: column;
          align-items: center;
          gap: 8px;
        }
        .tense-info {
          font-size: 14px;
        }
      }
      @media (max-width: 400px) {
        #quiz-container {
          padding: 12px;
          margin: 12px;
        }
        h1 {
          font-size: 20px;
        }
        #question {
          font-size: 16px;
        }
        #question-zh,
        .option-zh,
        #stats {
          font-size: 12px;
        }
        .option,
        .select-all-option,
        .true-false-option {
          padding: 10px;
          font-size: 14px;
        }
        .fill-in-the-blank input[type="text"] {
          font-size: 14px;
          padding: 8px;
          max-width: 200px;
        }
        #feedback {
          font-size: 14px;
        }
        #next-btn,
        #exit-btn,
        #submit-btn,
        #retry-btn {
          font-size: 14px;
          padding: 8px 16px;
        }
        .tense-info {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div id="quiz-container">
      <h1>IELTS Vocabulary Practice</h1>
      <div id="progress-container">
        <div id="progress-bar"></div>
        <div id="missed-progress-bar"></div>
        <p id="stats">Progress: 0% | Correct: 0 | Missed: 0</p>
      </div>
      <div id="question"></div>
      <div id="options"></div>
      <div id="feedback"></div>
      <div class="button-container">
        <button id="submit-btn" style="display: none">Submit</button>
        <button id="next-btn" style="display: none">Next Question</button>
        <button id="retry-btn" style="display: none">Retry</button>
        <button id="exit-btn">Back to Home</button>
      </div>
    </div>

    <script src="https://code.responsivevoice.org/responsivevoice.js?key=lsWadmqI"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let vocabList = [];
        let originalVocabLength = 0;
        let currentQuestion = 0;
        let currentSubQuestion = 0;
        let score = 0;
        let missedWords = [];
        let originalMissedWords = [];
        let answerSelected = false;
        let missedQuestionsAnswered = 0;

        const questionEl = document.getElementById("question");
        const optionsEl = document.getElementById("options");
        const feedbackEl = document.getElementById("feedback");
        const nextBtn = document.getElementById("next-btn");
        const submitBtn = document.getElementById("submit-btn");
        const exitBtn = document.getElementById("exit-btn");
        const retryBtn = document.getElementById("retry-btn");
        const progressBar = document.getElementById("progress-bar");
        const missedProgressBar = document.getElementById(
          "missed-progress-bar"
        );
        const statsEl = document.getElementById("stats");

        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        const dbName = params.get("db") || "environment1";
        const quizType = params.get("type") || "vocabulary";
        const limit = params.get("limit") || "all";
        const jsonFile = `data/${quizType}/${dbName}.json`;

        // Load JSON data
        async function loadQuestions() {
          try {
            console.log("HDR: Attempting to load JSON file:", jsonFile);
            const response = await fetch(jsonFile);
            if (!response.ok) {
              throw new Error(
                `HTTP error ${response.status}: ${response.statusText}`
              );
            }
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              throw new Error(
                `Expected JSON, got content-type: ${contentType}`
              );
            }
            vocabList = await response.json();
            console.log("HDR: Successfully loaded vocabList:", vocabList);

            // Normalize vocabList to array if single object (e.g., conjugation1.json)
            if (!Array.isArray(vocabList)) {
              vocabList = [vocabList];
            }

            // Apply question limit
            if (limit !== "all") {
              const maxQuestions = parseInt(limit);
              vocabList = vocabList
                .sort(() => Math.random() - 0.5)
                .slice(0, maxQuestions);
            } else {
              vocabList = vocabList.sort(() => Math.random() - 0.5);
            }

            originalVocabLength = vocabList.length;
            currentQuestion = 0;
            currentSubQuestion = 0;
            loadQuestion();
          } catch (e) {
            console.error("HDR: Error loading questions:", {
              file: jsonFile,
              error: e.message,
              stack: e.stack,
            });
            questionEl.textContent = `Error loading quiz data for "${dbName}". File "${jsonFile}" may be missing or invalid.`;
            optionsEl.innerHTML = "";
            feedbackEl.textContent = `Please check the file path, ensure "${jsonFile}" exists, and verify it contains valid JSON.`;
            nextBtn.style.display = "none";
            submitBtn.style.display = "none";
            retryBtn.style.display = "block";
            exitBtn.style.display = "block";
            updateProgress();
          }
        }

        function updateProgress() {
          try {
            let totalSubQuestions = 0;
            let completedSubQuestions = 0;
            vocabList.forEach((q, index) => {
              const subCount = q.subQuestions ? q.subQuestions.length : 1;
              totalSubQuestions += subCount;
              if (index < currentQuestion) {
                completedSubQuestions += subCount;
              } else if (index === currentQuestion) {
                completedSubQuestions += currentSubQuestion;
              }
            });
            const progress =
              totalSubQuestions > 0
                ? (completedSubQuestions / totalSubQuestions) * 100
                : 0;
            progressBar.style.width = `${progress}%`;
            const missedProgress =
              missedWords.length > 0
                ? (missedQuestionsAnswered / missedWords.length) * 100
                : 0;
            missedProgressBar.style.width = `${missedProgress}%`;
            statsEl.textContent = `Progress: ${progress.toFixed(
              1
            )}% | Correct: ${score} | Missed: ${originalMissedWords.length}`;
          } catch (e) {
            console.error("HDR: Error in updateProgress:", e);
          }
        }

        function loadQuestion() {
          try {
            console.log(
              "HDR: Loading question:",
              currentQuestion,
              "Sub-question:",
              currentSubQuestion
            );
            if (!vocabList.length) {
              questionEl.textContent = "No questions available.";
              optionsEl.innerHTML = "";
              feedbackEl.textContent = "";
              nextBtn.style.display = "none";
              submitBtn.style.display = "none";
              retryBtn.style.display = "none";
              updateProgress();
              return;
            }
            if (!questionEl || !optionsEl) {
              console.error("HDR: DOM elements missing:", {
                questionEl,
                optionsEl,
              });
              return;
            }
            const q = vocabList[currentQuestion];
            let speechQuestion = q.question
              .replace(/___/g, "fill in the blank")
              .replace(/'/g, "\\'");
            let currentSubQ = null;

            if (q.type === "fill-in-the-blank" && q.subQuestions) {
              if (currentSubQuestion >= q.subQuestions.length) {
                currentQuestion++;
                currentSubQuestion = 0;
                if (currentQuestion < vocabList.length) {
                  loadQuestion();
                } else {
                  handleQuizCompletion();
                }
                return;
              }
              currentSubQ = q.subQuestions[currentSubQuestion];
              speechQuestion = currentSubQ.sentence
                .replace(/___/g, "fill in the blank")
                .replace(/'/g, "\\'");
              questionEl.innerHTML = `<span>${currentSubQ.sentence}</span><svg class="audio-icon" onclick="responsiveVoice.speak('${speechQuestion}', 'UK English Female'); console.log('TTS Sub-Question:', '${speechQuestion}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
              const tenseDiv = document.createElement("div");
              tenseDiv.className = "tense-info";
              tenseDiv.textContent = `${currentSubQ.tense} (${currentSubQ.tenseZh})`;
              optionsEl.innerHTML = "";
              optionsEl.appendChild(tenseDiv);
            } else {
              questionEl.innerHTML = `<span>${q.question}</span><svg class="audio-icon" onclick="responsiveVoice.speak('${speechQuestion}', 'UK English Female'); console.log('TTS Question:', '${speechQuestion}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
              optionsEl.innerHTML = "";
            }

            const existingQuestionZh = document.getElementById("question-zh");
            if (existingQuestionZh) {
              existingQuestionZh.remove();
            }

            feedbackEl.textContent = "";
            nextBtn.style.display = "none";
            submitBtn.style.display = "none";
            retryBtn.style.display = "none";
            answerSelected = false;

            if (q.type === "multiple-choice" || q.type === "true-false") {
              q.options.forEach((option) => {
                const optionDiv = document.createElement("div");
                optionDiv.className =
                  q.type === "true-false" ? "true-false-option" : "option";
                optionDiv.dataset.value = option;
                const speechOption = option
                  .replace(/___/g, "fill in the blank")
                  .replace(/'/g, "\\'");
                optionDiv.innerHTML = `<span>${option}</span><svg class="audio-icon" onclick="responsiveVoice.speak('${speechOption}', 'UK English Female'); console.log('TTS Option:', '${speechOption}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
                optionDiv.onclick = (e) => {
                  if (e.target.tagName !== "SVG" && !e.target.closest("svg"))
                    checkAnswer(option);
                };
                optionsEl.appendChild(optionDiv);
              });
            } else if (q.type === "select-all") {
              q.options.forEach((option, i) => {
                const optionDiv = document.createElement("div");
                optionDiv.className = "select-all-option";
                const optionNumber = (i + 1).toString();
                optionDiv.dataset.value = optionNumber;
                const speechOption = option
                  .replace(/___/g, "fill in the blank")
                  .replace(/'/g, "\\'");
                optionDiv.innerHTML = `<label><input type="checkbox" value="${optionNumber}" style="margin-right: 10px;" name="select-all-option">${optionNumber}. ${option}</label><svg class="audio-icon" onclick="responsiveVoice.speak('${speechOption}', 'UK English Female'); console.log('TTS Option:', '${speechOption}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
                optionsEl.appendChild(optionDiv);
              });
              submitBtn.style.display = "block";
            } else if (q.type === "fill-in-the-blank") {
              const fillDiv = document.createElement("div");
              fillDiv.className = "fill-in-the-blank";
              if (q.subQuestions) {
                fillDiv.innerHTML = `<input type="text" id="fill-input" placeholder="Type your answer" /><svg class="audio-icon" onclick="responsiveVoice.speak('${speechQuestion}', 'UK English Female'); console.log('TTS Fill:', '${speechQuestion}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
                optionsEl.appendChild(fillDiv);
              } else {
                fillDiv.innerHTML = `<input type="text" id="fill-input" placeholder="Type your answer" /><svg class="audio-icon" onclick="responsiveVoice.speak('${speechQuestion}', 'UK English Female'); console.log('TTS Fill:', '${speechQuestion}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
                optionsEl.appendChild(fillDiv);
              }
              submitBtn.style.display = "block";
            }

            updateProgress();
          } catch (e) {
            console.error("HDR: Error in loadQuestion:", e);
            questionEl.textContent =
              "Error loading question. Please try again.";
            retryBtn.style.display = "block";
          }
        }

        function showChineseTranslations() {
          if (answerSelected) return;
          const q = vocabList[currentQuestion];
          let currentSubQ = q.subQuestions
            ? q.subQuestions[currentSubQuestion]
            : null;

          try {
            const questionZhDiv = document.createElement("div");
            questionZhDiv.id = "question-zh";
            questionZhDiv.textContent = currentSubQ
              ? currentSubQ.sentenceZh
              : q.questionZh || q.question;
            questionEl.insertAdjacentElement("afterend", questionZhDiv);

            if (q.type === "multiple-choice" || q.type === "true-false") {
              const newOptionsEl = document.createElement("div");
              q.options.forEach((option, i) => {
                const optionContainer = document.createElement("div");
                const optionDiv = document.createElement("div");
                optionDiv.className =
                  q.type === "true-false" ? "true-false-option" : "option";
                optionDiv.dataset.value = option;
                if (
                  optionsEl.querySelector(
                    `.${
                      q.type === "true-false" ? "true-false-option" : "option"
                    }[data-value="${option}"]`
                  )
                ) {
                  const originalDiv = optionsEl.querySelector(
                    `.${
                      q.type === "true-false" ? "true-false-option" : "option"
                    }[data-value="${option}"]`
                  );
                  if (originalDiv.classList.contains("correct")) {
                    optionDiv.classList.add("correct");
                  } else if (originalDiv.classList.contains("incorrect")) {
                    optionDiv.classList.add("incorrect");
                  }
                }
                const speechOption = option
                  .replace(/___/g, "fill in the blank")
                  .replace(/'/g, "\\'");
                optionDiv.innerHTML = `<span>${option}</span><svg class="audio-icon" onclick="responsiveVoice.speak('${speechOption}', 'UK English Female'); console.log('TTS Option:', '${speechOption}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
                optionDiv.onclick = (e) => {
                  if (e.target.tagName !== "SVG" && !e.target.closest("svg"))
                    checkAnswer(option);
                };
                if (
                  optionsEl.querySelectorAll(
                    `.${
                      q.type === "true-false" ? "true-false-option" : "option"
                    }`
                  ).length > 0 &&
                  optionsEl.querySelectorAll(
                    `.${
                      q.type === "true-false" ? "true-false-option" : "option"
                    }`
                  )[0].style.pointerEvents === "none"
                ) {
                  optionDiv.style.pointerEvents = "none";
                }
                optionContainer.appendChild(optionDiv);
                const optionZhDiv = document.createElement("div");
                optionZhDiv.className = "option-zh";
                optionZhDiv.textContent =
                  q.optionsZh[i] || "No Chinese translation";
                optionContainer.appendChild(optionZhDiv);
                newOptionsEl.appendChild(optionContainer);
              });
              optionsEl.innerHTML = "";
              optionsEl.appendChild(newOptionsEl);
            } else if (q.type === "select-all") {
              const newOptionsEl = document.createElement("div");
              q.options.forEach((option, i) => {
                const optionContainer = document.createElement("div");
                const optionDiv = document.createElement("div");
                optionDiv.className = "select-all-option";
                const optionNumber = (i + 1).toString();
                optionDiv.dataset.value = optionNumber;
                if (
                  optionsEl.querySelector(
                    `.select-all-option[data-value="${optionNumber}"]`
                  )
                ) {
                  const originalDiv = optionsEl.querySelector(
                    `.select-all-option[data-value="${optionNumber}"]`
                  );
                  if (originalDiv.classList.contains("correct")) {
                    optionDiv.classList.add("correct");
                  } else if (originalDiv.classList.contains("incorrect")) {
                    optionDiv.classList.add("incorrect");
                  }
                }
                const speechOption = option
                  .replace(/___/g, "fill in the blank")
                  .replace(/'/g, "\\'");
                optionDiv.innerHTML = `<label><input type="checkbox" value="${optionNumber}" style="margin-right: 10px;" name="select-all-option">${optionNumber}. ${option}</label><svg class="audio-icon" onclick="responsiveVoice.speak('${speechOption}', 'UK English Female'); console.log('TTS Option:', '${speechOption}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
                if (
                  optionsEl.querySelectorAll(".select-all-option").length > 0 &&
                  optionsEl.querySelectorAll(".select-all-option")[0].style
                    .pointerEvents === "none"
                ) {
                  optionDiv.style.pointerEvents = "none";
                  optionDiv.querySelector("input").disabled = true;
                }
                optionContainer.appendChild(optionDiv);
                const optionZhDiv = document.createElement("div");
                optionZhDiv.className = "option-zh";
                optionZhDiv.textContent =
                  q.optionsZh[i] || "No Chinese translation";
                optionContainer.appendChild(optionZhDiv);
                newOptionsEl.appendChild(optionContainer);
              });
              optionsEl.innerHTML = "";
              optionsEl.appendChild(newOptionsEl);
            } else if (q.type === "fill-in-the-blank") {
              const newOptionsEl = document.createElement("div");
              const fillDiv = document.createElement("div");
              fillDiv.className = "fill-in-the-blank";
              const inputEl = optionsEl.querySelector("#fill-input");
              if (inputEl) {
                if (inputEl.classList.contains("correct")) {
                  fillDiv.innerHTML = `<input type="text" id="fill-input" value="${inputEl.value}" class="correct" disabled />`;
                } else if (inputEl.classList.contains("incorrect")) {
                  fillDiv.innerHTML = `<input type="text" id="fill-input" value="${inputEl.value}" class="incorrect" disabled />`;
                } else {
                  fillDiv.innerHTML = `<input type="text" id="fill-input" placeholder="Type your answer" />`;
                }
                fillDiv.innerHTML += `<svg class="audio-icon" onclick="responsiveVoice.speak('${speechQuestion}', 'UK English Female'); console.log('TTS Fill:', '${speechQuestion}')" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
              }
              if (q.subQuestions) {
                const tenseDiv = document.createElement("div");
                tenseDiv.className = "tense-info";
                tenseDiv.textContent = `${currentSubQ.tense} (${currentSubQ.tenseZh})`;
                newOptionsEl.appendChild(tenseDiv);
              }
              newOptionsEl.appendChild(fillDiv);
              optionsEl.innerHTML = "";
              optionsEl.appendChild(newOptionsEl);
            }
            answerSelected = true;
          } catch (e) {
            console.error("HDR: Error in showChineseTranslations:", e);
          }
        }

        function checkAnswer(selected) {
          const q = vocabList[currentQuestion];
          let isCorrect = false;
          let feedbackText = "";
          let currentSubQ = q.subQuestions
            ? q.subQuestions[currentSubQuestion]
            : null;

          try {
            if (q.type === "multiple-choice" || q.type === "true-false") {
              isCorrect = selected === q.correct;
              feedbackText = isCorrect
                ? `Correct! ${q.example} (${q.exampleZh || q.example})`
                : `Incorrect. The correct answer is "${q.correct}". ${
                    q.example
                  } (${q.exampleZh || q.example})`;
              optionsEl
                .querySelectorAll(".option, .true-false-option")
                .forEach((div) => {
                  div.style.pointerEvents = "none";
                  if (div.dataset.value === q.correct) {
                    div.classList.add("correct");
                  } else if (div.dataset.value === selected) {
                    div.classList.add("incorrect");
                  }
                });
            } else if (q.type === "select-all") {
              const selectedOptions = Array.from(
                optionsEl.querySelectorAll(
                  'input[name="select-all-option"]:checked'
                )
              ).map((input) => input.value);
              if (selectedOptions.length === 0) {
                isCorrect = false;
                feedbackText = `Incorrect. You must select at least one option. The correct answers are options ${q.correct.join(
                  ", "
                )}. ${q.example} (${q.exampleZh || q.example})`;
              } else {
                const sortedSelected = selectedOptions.sort();
                const sortedCorrect = q.correct.sort();
                isCorrect =
                  sortedSelected.length === sortedCorrect.length &&
                  sortedSelected.every((opt, i) => opt === sortedCorrect[i]);
                feedbackText = isCorrect
                  ? `Correct! ${q.example} (${q.exampleZh || q.example})`
                  : `Incorrect. The correct answers are options ${q.correct.join(
                      ", "
                    )}. ${q.example} (${q.exampleZh || q.example})`;
              }
              optionsEl
                .querySelectorAll(".select-all-option")
                .forEach((div) => {
                  div.style.pointerEvents = "none";
                  div.querySelector("input").disabled = true;
                  const value = div.dataset.value;
                  if (q.correct.includes(value)) {
                    div.classList.add("correct");
                  } else if (selectedOptions.includes(value)) {
                    div.classList.add("incorrect");
                  }
                });
            } else if (q.type === "fill-in-the-blank") {
              const userInput = optionsEl
                .querySelector("#fill-input")
                .value.trim();
              const correctAnswer = currentSubQ
                ? currentSubQ.answer
                : q.correct;
              const exampleText = currentSubQ ? currentSubQ.example : q.example;
              const exampleZhText = currentSubQ
                ? currentSubQ.exampleZh
                : q.exampleZh || q.example;
              isCorrect = userInput === correctAnswer; // Case-sensitive match
              feedbackText = isCorrect
                ? `Correct! ${exampleText} (${exampleZhText})`
                : `Incorrect. The correct answer is "${correctAnswer}". ${exampleText} (${exampleZhText})`;
              const inputEl = optionsEl.querySelector("#fill-input");
              inputEl.classList.add(isCorrect ? "correct" : "incorrect");
              inputEl.disabled = true;
            }

            showChineseTranslations();
            feedbackEl.textContent = feedbackText;
            feedbackEl.className = isCorrect ? "green" : "red";
            if (isCorrect && currentQuestion < originalVocabLength) {
              score++;
            } else if (!isCorrect) {
              if (
                currentQuestion < originalVocabLength &&
                !originalMissedWords.includes(q)
              ) {
                originalMissedWords.push(q);
              }
              if (!missedWords.includes(q)) {
                missedWords.push(q);
              }
            }
            nextBtn.style.display = "block";
            submitBtn.style.display = "none";
            retryBtn.style.display = "none";
            updateProgress();
          } catch (e) {
            console.error("HDR: Error in checkAnswer:", e);
            feedbackEl.textContent =
              "Error processing answer. Please try again.";
            retryBtn.style.display = "block";
          }
        }

        submitBtn.onclick = () => {
          try {
            const q = vocabList[currentQuestion];
            if (q.type === "select-all" || q.type === "fill-in-the-blank") {
              checkAnswer(null);
            }
          } catch (e) {
            console.error("HDR: Error in submitBtn.onclick:", e);
          }
        };

        exitBtn.onclick = () => {
          try {
            window.location.href = "index.html";
          } catch (e) {
            console.error("HDR: Error in exitBtn.onclick:", e);
          }
        };

        retryBtn.onclick = () => {
          try {
            loadQuestions();
          } catch (e) {
            console.error("HDR: Error in retryBtn.onclick:", e);
          }
        };

        function handleQuizCompletion() {
          if (missedWords.length > 0) {
            missedQuestionsAnswered += missedWords.length;
            vocabList = missedWords;
            missedWords = [];
            currentQuestion = 0;
            currentSubQuestion = 0;
            loadQuestion();
          } else {
            questionEl.textContent = "Quiz Complete!";
            const existingQuestionZh = document.getElementById("question-zh");
            if (existingQuestionZh) {
              existingQuestionZh.remove();
            }
            optionsEl.innerHTML = "";
            feedbackEl.textContent =
              originalMissedWords.length > 0
                ? `Review these: ${originalMissedWords
                    .map((q) => q.word)
                    .join(", ")}.`
                : "Perfect!";
            feedbackEl.className = "";
            nextBtn.style.display = "none";
            submitBtn.style.display = "none";
            retryBtn.style.display = "none";
            exitBtn.style.display = "block";
            updateProgress();
          }
        }

        nextBtn.onclick = () => {
          try {
            const q = vocabList[currentQuestion];
            if (q.type === "fill-in-the-blank" && q.subQuestions) {
              currentSubQuestion++;
              if (currentSubQuestion < q.subQuestions.length) {
                loadQuestion();
              } else {
                currentQuestion++;
                currentSubQuestion = 0;
                if (currentQuestion < vocabList.length) {
                  loadQuestion();
                } else {
                  handleQuizCompletion();
                }
              }
            } else {
              currentQuestion++;
              if (currentQuestion < vocabList.length) {
                loadQuestion();
              } else {
                handleQuizCompletion();
              }
            }
          } catch (e) {
            console.error("HDR: Error in nextBtn.onclick:", e);
            retryBtn.style.display = "block";
          }
        };

        try {
          loadQuestions();
        } catch (e) {
          console.error("HDR: Initial loadQuestions error:", e);
          questionEl.textContent =
            "Error loading quiz. Please refresh the page.";
          retryBtn.style.display = "block";
        }
      });
    </script>
  </body>
</html>
